name: CI â€“ Generate Models & Annotations, Build ORD-Java

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Generate & Build ORD-Java
    runs-on: [self-hosted, solinas]
    permissions:
      contents: write

    steps:
      - name: Checkout ord-maven repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Checkout ORD-Spec repo
        uses: actions/checkout@v3
        with:
          repository: CentralEngineering/open-resource-discovery-specification
          ref: main
          path: ord-spec

      - name: Set up Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ord-spec/package-lock.json

      - name: Install ORD-Spec npm dependencies
        run: npm ci
        working-directory: ord-spec

      - name: Generate ORD schemas
        run: npm run generate
        working-directory: ord-spec

      - name: Generate Java Annotation Interfaces
        working-directory: ord-spec
        run: |
          mkdir -p ../java/annotations/target/generated-sources
          npx ts-node src/helper/generateJavaAnnotations.ts \
            --outDir ../java/annotations/target/generated-sources

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Download jsonschema2pojo CLI
        run: |
          curl -L -o jsonschema2pojo.zip \
            https://github.com/joelittlejohn/jsonschema2pojo/releases/download/jsonschema2pojo-1.2.2/jsonschema2pojo-1.2.2.zip
          unzip jsonschema2pojo.zip -d jsonschema2pojo

      - name: Generate Java POJOs from JSON Schema
        run: |
          mkdir -p java/models/src/main/java
          java -jar jsonschema2pojo/jsonschema2pojo-1.2.2/lib/jsonschema2pojo-cli-1.2.2.jar \
            --source ord-spec/static/spec-v1/interfaces/Document.schema.json \
            --target java/models/src/main/java \
            --package com.github.openresourcediscovery.model \
            --generate-constructors \
            --generate-builders

      - name: List generated annotation files
        run: ls -R ord-spec/java/annotations/target/generated-sources

      - name: List generated model files
        run: ls -R java/models/src/main/java

      - name: Copy annotations into root-level annotations folder
        run: |
          mkdir -p annotations/src/main/java
          cp -R ord-spec/java/annotations/target/generated-sources/* annotations/src/main/java

      - name: Copy models into root-level models folder
        run: |
          mkdir -p models/src/main/java
          cp -R java/models/src/main/java/* models/src/main/java/

      - name: Remove ord-spec and existing java folder
        run: |
          rm -rf ord-spec
          rm -rf java

      - name: Create annotations/pom.xml
        run: |
          cat > annotations/pom.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <project xmlns="http://maven.apache.org/POM/4.0.0"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
                                      http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>

            <parent>
              <groupId>com.github.openresourcediscovery</groupId>
              <artifactId>ord-java</artifactId>
              <version>1.0.0</version>
            </parent>

            <artifactId>ord-annotations</artifactId>
            <name>ORD Annotations</name>

            <build>
              <sourceDirectory>src/main/java</sourceDirectory>

              <plugins>
               <plugin>
                  <groupId>org.codehaus.mojo</groupId>
                  <artifactId>build-helper-maven-plugin</artifactId>
                  <version>3.4.0</version>
                  <executions>
                    <execution>
                      <id>add-generated-sources</id>
                      <phase>generate-sources</phase>
                      <goals>
                        <goal>add-source</goal>
                      </goals>
                      <configuration>
                        <sources>
                          <source>${project.basedir}/target/generated-sources</source>
                        </sources>
                      </configuration>
                    </execution>
                  </executions>
                </plugin>
              </plugins>
            </build>
          </project>
          EOF

      - name: Create models/pom.xml
        run: |
          cat > models/pom.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <project xmlns="http://maven.apache.org/POM/4.0.0"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
                                      http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>

            <parent>
              <groupId>com.github.openresourcediscovery</groupId>
              <artifactId>ord-java</artifactId>
              <version>1.0.0</version>
            </parent>

            <artifactId>ord-models</artifactId>
            <name>ORD Java Models</name>

            <dependencies>
              <dependency>
                <groupId>com.fasterxml.jackson.core</groupId>
                <artifactId>jackson-annotations</artifactId>
                <version>2.17.0</version>
              </dependency>
            </dependencies>

            <build>
              <plugins>
               <plugin>
                  <groupId>org.codehaus.mojo</groupId>
                  <artifactId>build-helper-maven-plugin</artifactId>
                  <version>3.4.0</version>
                  <executions>
                    <execution>
                      <id>add-generated-sources</id>
                      <phase>generate-sources</phase>
                      <goals>
                        <goal>add-source</goal>
                      </goals>
                      <configuration>
                        <sources>
                          <source>${project.build.directory}/generated-sources</source>
                        </sources>
                      </configuration>
                    </execution>
                  </executions>
                </plugin>
              </plugins>
            </build>
          </project>
          EOF

      - name: Create or update pull request for generated sources
        uses: peter-evans/create-pull-request@v5
        with:
          branch: generated-sources
          commit-message: "chore(ci): update generated annotations & models"
          title: "chore(ci): update generated annotations & models"
          body: |
            This PR automatically updates the generated annotations and models in the folders:
            - annotations/src/main/java
            - models/src/main/java

            Changes are automatically pushed to 'generated sources' by the CI workflow on main.
          base: main
          path: |
            annotations/src/main/java/**
            models/src/main/java/**